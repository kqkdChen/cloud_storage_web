<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Huploadify demo</title>
    <link rel="stylesheet" type="text/css" href="Huploadify.css"/>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jquery.Huploadify.js"></script>
    <script type="text/javascript" src="core.js" ></script>
    <script type="text/javascript" src="sha1.js" ></script>
    <style type="text/css">
    </style>
    <script type="text/javascript">
        var fileNameWithSHA1 = [];
        $(function(){
            var up = $('#upload').Huploadify({
                auto:false,
                fileTypeExts:'*.txt;*.jpg;*.png;*.avi;*.rar;*.exe;*.mp3;*.mp4;*.zip;*.doc;*.docx;*.ppt;*.pptx;*.xls;*.xlsx;*.pdf;*.md',
                multi:true,
                breakPoints:true,
                saveInfoLocal:true,
                showUploadedPercent:true,//是否实时显示上传的百分比，如20%
                showUploadedSize:true,
                fileSizeLimit: 2048 * 1024,
                fileSplitSize: 5 * 1024 * 1024,
                removeTimeout:9999999,
                uploader:'http://localhost/file/upload',
                onSelect: function (files) {
                    console.log(files);
                    for (var f in files) {
                        var file = {};
                        file.fileName = files[f].name;
                        calSHA1(files[f]).then(function (result) {
                            file.sha1 = result;
                        });
                        fileNameWithSHA1.push(file);
                    }

                    console.log(fileNameWithSHA1)
                },
                onUploadStart:function(){

                    // console.log(file);
                    //up.settings('formData', {aaaaa:'1111111',bb:'2222'});
                    // up.Huploadify('settings','formData', {aaaaa:'1111111',bb:'2222'});
                },
                onUploadSuccess:function(file){

                    calSHA1(file).then(function (result) {
                        console.log(result);
                    })
                    //alert('上传成功');
                },
                onUploadComplete:function(){
                    //alert('上传完成');
                },
                /*getUploadedSize:function(file){
                    var data = {
                        data : {
                            fileSHA1: '',
                        }
                    };
                    var url = 'http://localhost/file/getUploadSize';
                    var uploadedSize = 0;
                    $.ajax({
                        url : url,
                        data : data,
                        async : false,
                        type : 'get',
                        dataType: 'json',
                        success : function(returnData){
                            uploadedSize = returnData.uploadedSize;
                        }
                    });
                    return uploadedSize;
                }*/
            });

            $('#btn1').click(function(){
                up.stop();
            });
            $('#btn2').click(function(){
                up.upload('*');
            });
            $('#btn3').click(function(){
                up.cancel('*');
            });
            $('#btn4').click(function(){
                //up.disable();
                up.Huploadify('disable');
            });
            $('#btn5').click(function(){
                up.ennable();
            });
            $('#btn6').click(function(){
                up.destroy();
            });

        });

        function calSHA1(file) {
            //使用FileReader对象对文件的二进制进行sha-1的hash计算

            return new Promise(function (resolve, reject) {
                var reader = new FileReader();
                //当整个文件加载完成后，开始进行hash值的计算操作
                reader.readAsBinaryString(file);
                reader.onload = function (e) {
                    var binary = e.target.result;
                    resolve(CryptoJS.SHA1(CryptoJS.enc.Latin1.parse(binary)).toString());
                    // sha1_hash = CryptoJS.SHA1(CryptoJS.enc.Latin1.parse(binary)).toString();
                };
            });
        }

    </script>
</head>

<body>
<div id="upload"></div>
<button id="btn1">stop</button>
<button id="btn2">upload</button>
<button id="btn3">cancel</button>
<button id="btn4">disable</button>
<button id="btn5">ennable</button>
<button id="btn6">destroy</button>

</body>
</html>
