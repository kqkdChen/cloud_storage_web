<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>登录</title>
    <link rel="stylesheet" href="assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="assets/css/login.css?v=312">
    <link rel="stylesheet" href="assets/module/admin.css?v=312"/>
    <script type="text/javascript" src="assets/js/jquery.js"></script>
    <script type="text/javascript" src="assets/js/md5.js"></script>
</head>
<body>
<div class="login-wrapper">
    <div class="login-header">
        <img src="assets/images/logo.png"> SpeedPan
    </div>

    <div class="login-body" id="loginForm">
        <div class="layui-card" style="height: 350px; padding: 25px 30px;" >
            <div class="layui-card-header" style="margin-bottom: 30px;"><h2 style="font-weight: 700; font-size: 30px;text-align: center">用户登录</h2>
            </div>
            <form class="layui-card-body layui-form layui-form-pane" style="font-weight: 500">
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-username"></i></label>
                    <div class="layui-input-block">
                        <input name="userAccount" type="text" placeholder="请输入账号" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-password"></i></label>
                    <div class="layui-input-block">
                        <input name="userPassword" type="password" placeholder="请输入密码" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-vercode"></i></label>
                    <div class="layui-input-block">
                        <div class="layui-row inline-block">
                            <div class="layui-col-xs7">
                                <input name="verifyCode" type="text" placeholder="验证码" class="layui-input"
                                       autocomplete="off" lay-verType="tips" lay-verify="required" required/>
                            </div>
                            <div class="layui-col-xs5" style="padding-left: 6px;">
                                <img class="login-captcha" src="http://192.168.2.54/u/verifyCode">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <a href="javascript:void(0);" id="register" style="color: #4aca85 !important;" class="layui-link">帐号注册</a>
                    <a href="javascript:void(0);" style="color: #4aca85 !important;" class="layui-link pull-right">忘记密码？</a>
                </div>
                <div class="layui-form-item">
                    <button lay-filter="login-submit" class="layui-btn layui-btn-fluid" style="font-size: 16px; margin-top: 10px; height: 44px; line-height: 44px; background: #4aca85; border-radius: 5px;" lay-submit>登 录</button>
                </div>
            </form>
        </div>
    </div>


    <div class="login-body layui-hide" id="registerForm">
        <div class="layui-card" style="height: 415px; padding: 25px 30px;" >
            <div class="layui-card-header" style="margin-bottom: 30px;"><h2 style="font-weight: 700; font-size: 30px;text-align: center">用户注册</h2>
            </div>
            <form class="layui-card-body layui-form layui-form-pane" style="font-weight: 500">
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-username"></i></label>
                    <div class="layui-input-block">
                        <input name="userAccount" type="text" placeholder="请输入账号" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-password"></i></label>
                    <div class="layui-input-block">
                        <input name="userPassword" id="pwd" type="password" placeholder="请输入密码" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-password"></i></label>
                    <div class="layui-input-block">
                        <input name="confirm_pwd" id="confirm_pwd" type="password" placeholder="请确认密码" class="layui-input"
                               lay-verType="tips" lay-verify="required" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-release"></i></label>
                    <div class="layui-input-block">
                        <input name="userEmail" id="email" lay-verify="email" type="text" placeholder="请输入邮箱" class="layui-input"
                               lay-verType="tips" required/>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><i class="layui-icon layui-icon-vercode"></i></label>
                    <div class="layui-input-block">
                        <div class="layui-row inline-block">
                            <div class="layui-col-xs7">
                                <input name="mailCode" type="text" placeholder="验证码" class="layui-input"
                                       autocomplete="off" lay-verType="tips" lay-verify="required" required/>
                            </div>
                            <div class="layui-col-xs5" style="padding-left: 6px;">
                                <a href="#" id="sendEmilBtn" class="layui-btn send" style="background: #4aca85;">发送验证码</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item" style="text-align: center">
                    <a href="#" class="layui-btn" style="font-size: 16px; margin-top: 10px; height: 44px; margin-right: 30px; line-height: 44px; padding: 0 25px; color: #4aca85; background: transparent !important; border: 1px solid #4aca85; border-radius: 5px;">返回登录</a>
                    <button lay-filter="register-submit" class="layui-btn" style="font-size: 16px; margin-top: 10px; height: 44px; line-height: 44px; padding: 0 25px; background: #4aca85; border-radius: 5px;" lay-submit>立即注册</button>
                </div>
            </form>
        </div>
    </div>

    <div class="login-footer">
        <p>© 2019 kqkd.info 版权所有</p>
    </div>
</div>

<!-- 加载动画 -->
<div class="page-loading">
    <div class="ball-loader">
        <span></span><span></span><span></span><span></span>
    </div>
</div>
<script type="text/javascript" src="assets/libs/layui/layui.js"></script>
<script>
    layui.config({
        base: '../../assets/module/'
    }).use(['config', 'form', 'admin'], function () {
        var $ = layui.jquery;
        var form = layui.form;
        var config = layui.config;
        var admin = layui.admin;
        var time = 60;
        var clock = '';
        var mailBtn = $('#sendEmilBtn');

        if (config.getToken()) {
            // location.replace('./');
            // return;
        }

        //移除loading动画
        setTimeout(function () {
            admin.removeLoading();
        }, 500);

        /* 切换登录与注册 */
        $('#register').on('click', function () {
            $('#loginForm').attr('class', 'login-body layui-hide');
            $('#registerForm').attr('class', 'login-body');
        });

        /* 发送验证码 */
        mailBtn.on('click', function () {
            var self = $(this);
            if (self.attr('class') === 'layui-btn layui-btn-disabled') {
                return;
            }
            var mail = $('#email').val();
            admin.req('u/mailCode', {'mail': mail}, function (msg) {
                if (msg == true) {
                    self.attr('class', 'layui-btn layui-btn-disabled');
                    self.css('background', '#fff');
                    clock = setInterval(timeChange, 1000);
                } else {
                    layer.msg("邮件服务器错误!", {time: 2000})
                }

            }, 'get');
        });

        /* 时间刷新特效 */
        function timeChange() {
            time --;
            console.log(time);
            if(time > 0){
                mailBtn.text(time+'秒后刷新');
            }else{
                clearInterval(clock); //清除js定时器
                mailBtn.attr('class', 'layui-btn send');
                mailBtn.val('发送验证码');
                time = 60; //重置时间
            }
        }

        if (config.getToken()) {
            // location.replace('./');
            // return;
        }

        /* 注册表单提交 */
        form.on('submit(register-submit)', function (data) {
            layer.load(2);
            $.ajax({
                url: 'http://192.168.2.54/u/register',
                type: 'post',
                data: data.field,
                dataType: 'json',
                success: function (data) {
                    if (data.result == true) {
                        layer.closeAll();
                        layer.msg('注册成功！三秒之后会自动跳转到登录界面', {time: 3000, btn: '确定', btnAlign: 'c'}, function () {
                            window.location.replace('login.html');
                        });
                    } else {
                        layer.closeAll();
                        layer.msg('验证码错误！', {time: 0, btn: '确定', btnAlign: 'c'}, function () {
                            // window.location.replace('/');
                        });
                    }
                }
            });
            return false;
        });


        // 登录表单提交
        form.on('submit(login-submit)', function (data) {
            var field = data.field;
            layer.load(2);
            /* 获取随机字符串 */
            admin.req('u/randomStr', {}, function (msg) {
                field.userPassword = $.md5($.md5(field.userPassword) + $.md5(msg.randomStr));
                $.ajax({
                    url: 'http://192.168.2.54/u/login',
                    data: field,
                    type: 'POST',
                    dataType: 'JSON',
                    success: function (res) {
                        if (res.access_token) {
                            config.putToken(res);
                            config.putUser(res.user);
                            layer.msg('登录成功', {icon: 1, time: 1000}, function () {
                                window.location.replace('index.html');
                            });
                        } else {
                            layer.closeAll('loading');
                            layer.msg(res.msg, {icon: 5});

                        }
                    },
                    error: function (xhr) {
                        layer.closeAll('loading');
                        if (xhr.status == 400) {
                            layer.msg('登录失败，请重试', {icon: 5});
                        }
                    }
                });
            }, 'get');
            return false;
        });

        // field.grant_type = 'password';
        // field.scope = 'select';
        // field.client_id = 'client_2';
        // field.client_secret = '123456';

        // 图形验证码
        $('.login-captcha').click(function () {
            this.src = "u/verifyCode" + '?t=' + (new Date).getTime();
        });
    });

</script>
</body>
</html>
